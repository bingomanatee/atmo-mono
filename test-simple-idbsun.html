<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple IDBSun Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { background: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; border-left: 4px solid #4CAF50; }
        .error { background: #ffe8e8; border-left: 4px solid #f44336; }
    </style>
</head>
<body>
    <h1>üîß Simple IDBSun Test</h1>
    <div id="status" class="status">Starting test...</div>
    
    <div style="background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007acc;">
        <h3>üéØ Simple Test Goals</h3>
        <p><strong>Test:</strong> Basic IDBSun functionality without multiverse complexity</p>
        <ol>
            <li><strong>Load IDB library</strong> - Import from CDN</li>
            <li><strong>Create simple IDBSun</strong> - Test basic functionality</li>
            <li><strong>Add/retrieve data</strong> - Verify storage works</li>
        </ol>
    </div>

    <div>
        <button id="testBasic">üß™ Test Basic IDBSun</button>
        <button id="testData">üìù Add Test Data</button>
        <button id="showData">üìä Show Data</button>
    </div>

    <div id="results"></div>

    <!-- Load IDB from CDN -->
    <script src="https://unpkg.com/idb@8/build/umd.js"></script>
    
    <script>
        console.log('üîß Script starting...');
        
        // Simple schema-like object
        const testSchema = {
            fields: {
                id: { type: 'string' },
                value: { type: 'number', meta: { index: true } },
                timestamp: { type: 'number', meta: { index: true } }
            }
        };

        let testDB = null;

        async function testBasicIDB() {
            try {
                console.log('üîß Testing basic IDB functionality...');
                document.getElementById('status').textContent = 'Testing basic IDB...';
                
                // Check if IDB loaded
                if (!window.idb) {
                    throw new Error('IDB library not loaded');
                }
                console.log('‚úÖ IDB library loaded');
                
                const { openDB, deleteDB } = window.idb;
                
                // Delete existing database
                console.log('üîß Deleting existing database...');
                try {
                    await deleteDB('simple-test');
                    console.log('‚úÖ Database deleted');
                } catch (error) {
                    console.log('‚ö†Ô∏è Database deletion failed (probably didn\'t exist):', error);
                }
                
                // Open database
                console.log('üîß Opening database...');
                testDB = await openDB('simple-test', 1, {
                    upgrade(db, oldVersion, newVersion, transaction) {
                        console.log(`üîß Database upgrade ${oldVersion} ‚Üí ${newVersion}`);
                        
                        if (!db.objectStoreNames.contains('testData')) {
                            console.log('üîß Creating object store...');
                            const store = db.createObjectStore('testData', { keyPath: 'id' });
                            store.createIndex('value', 'value');
                            store.createIndex('timestamp', 'timestamp');
                            console.log('‚úÖ Object store created');
                        }
                    },
                    blocked() {
                        console.log('‚ö†Ô∏è Database upgrade blocked');
                    },
                    blocking() {
                        console.log('‚ö†Ô∏è Database blocking other connections');
                    },
                });
                
                console.log('‚úÖ Database opened successfully');
                
                // Test basic operations
                console.log('üîß Testing basic operations...');
                
                // Add test data
                await testDB.put('testData', {
                    id: 'test1',
                    value: 42,
                    timestamp: Date.now()
                });
                console.log('‚úÖ Data added');
                
                // Retrieve data
                const retrieved = await testDB.get('testData', 'test1');
                console.log('‚úÖ Data retrieved:', retrieved);
                
                // Count data
                const count = await testDB.count('testData');
                console.log('‚úÖ Data count:', count);
                
                document.getElementById('status').textContent = 'Basic IDB test successful! ‚úÖ';
                document.getElementById('status').className = 'status success';
                
            } catch (error) {
                console.error('‚ùå Basic IDB test failed:', error);
                document.getElementById('status').textContent = `Basic IDB test failed: ${error.message}`;
                document.getElementById('status').className = 'status error';
            }
        }

        async function addTestData() {
            if (!testDB) {
                alert('Please run basic test first!');
                return;
            }
            
            try {
                const data = {
                    id: `test_${Date.now()}`,
                    value: Math.floor(Math.random() * 100),
                    timestamp: Date.now()
                };
                
                await testDB.put('testData', data);
                console.log('‚úÖ Test data added:', data);
                
                await showData();
            } catch (error) {
                console.error('‚ùå Failed to add test data:', error);
            }
        }

        async function showData() {
            if (!testDB) {
                alert('Please run basic test first!');
                return;
            }
            
            try {
                const allData = await testDB.getAll('testData');
                console.log('üìä All data:', allData);
                
                const resultsDiv = document.getElementById('results');
                let html = `<h3>üìä Data in Database: ${allData.length} items</h3>`;
                
                allData.forEach(item => {
                    html += `
                        <div style="border: 1px solid #ccc; margin: 5px; padding: 10px; background: #f9f9f9;">
                            <strong>ID:</strong> ${item.id}<br>
                            <strong>Value:</strong> ${item.value}<br>
                            <strong>Time:</strong> ${new Date(item.timestamp).toLocaleTimeString()}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Failed to show data:', error);
            }
        }

        // Event handlers
        document.getElementById('testBasic').addEventListener('click', testBasicIDB);
        document.getElementById('testData').addEventListener('click', addTestData);
        document.getElementById('showData').addEventListener('click', showData);

        // Auto-start test
        console.log('üîß Auto-starting basic test...');
        setTimeout(testBasicIDB, 1000);
    </script>
</body>
</html>
